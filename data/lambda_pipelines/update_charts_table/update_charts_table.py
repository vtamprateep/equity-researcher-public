import yfinance as yf # 0.2.38
import pandas as pd # 2.2.2
import datetime
import os

from supabase import create_client, Client


def lambda_handler(event, context):
    input_symbol = [{"symbol":"A","id":1},
        {"symbol":"AAL","id":2},
        {"symbol":"AAPL","id":3},
        {"symbol":"ABBV","id":4},
        {"symbol":"ABNB","id":5},
        {"symbol":"ABT","id":6},
        {"symbol":"ACGL","id":7},
        {"symbol":"ACN","id":8},
        {"symbol":"ADBE","id":9},
        {"symbol":"ADI","id":10},
        {"symbol":"ADM","id":11},
        {"symbol":"ADP","id":12},
        {"symbol":"ADSK","id":13},
        {"symbol":"AEE","id":14},
        {"symbol":"AEP","id":15},
        {"symbol":"AES","id":16},
        {"symbol":"AFL","id":17},
        {"symbol":"AIG","id":18},
        {"symbol":"AIZ","id":19},
        {"symbol":"AJG","id":20},
        {"symbol":"AKAM","id":21},
        {"symbol":"ALB","id":22},
        {"symbol":"ALGN","id":23},
        {"symbol":"ALL","id":24},
        {"symbol":"ALLE","id":25},
        {"symbol":"AMAT","id":26},
        {"symbol":"AMCR","id":27},
        {"symbol":"AMD","id":28},
        {"symbol":"AME","id":29},
        {"symbol":"AMGN","id":30},
        {"symbol":"AMP","id":31},
        {"symbol":"AMT","id":32},
        {"symbol":"AMZN","id":33},
        {"symbol":"ANET","id":34},
        {"symbol":"ANSS","id":35},
        {"symbol":"AON","id":36},
        {"symbol":"AOS","id":37},
        {"symbol":"APA","id":38},
        {"symbol":"APD","id":39},
        {"symbol":"APH","id":40},
        {"symbol":"APTV","id":41},
        {"symbol":"ARE","id":42},
        {"symbol":"ATO","id":43},
        {"symbol":"AVB","id":44},
        {"symbol":"AVGO","id":45},
        {"symbol":"AVY","id":46},
        {"symbol":"AWK","id":47},
        {"symbol":"AXON","id":48},
        {"symbol":"AXP","id":49},
        {"symbol":"AZO","id":50},
        {"symbol":"BA","id":51},
        {"symbol":"BAC","id":52},
        {"symbol":"BALL","id":53},
        {"symbol":"BAX","id":54},
        {"symbol":"BBWI","id":55},
        {"symbol":"BBY","id":56},
        {"symbol":"BDX","id":57},
        {"symbol":"BEN","id":58},
        {"symbol":"BG","id":59},
        {"symbol":"BIIB","id":60},
        {"symbol":"BIO","id":61},
        {"symbol":"BK","id":62},
        {"symbol":"BKNG","id":63},
        {"symbol":"BKR","id":64},
        {"symbol":"BLDR","id":65},
        {"symbol":"BLK","id":66},
        {"symbol":"BMY","id":67},
        {"symbol":"BR","id":68},
        {"symbol":"BRO","id":69},
        {"symbol":"BSX","id":70},
        {"symbol":"BWA","id":71},
        {"symbol":"BX","id":72},
        {"symbol":"BXP","id":73},
        {"symbol":"C","id":74},
        {"symbol":"CAG","id":75},
        {"symbol":"CAH","id":76},
        {"symbol":"CARR","id":77},
        {"symbol":"CAT","id":78},
        {"symbol":"CB","id":79},
        {"symbol":"CBOE","id":80},
        {"symbol":"CBRE","id":81},
        {"symbol":"CCI","id":82},
        {"symbol":"CCL","id":83},
        {"symbol":"CDNS","id":84},
        {"symbol":"CDW","id":85},
        {"symbol":"CE","id":86},
        {"symbol":"CEG","id":87},
        {"symbol":"CF","id":88},
        {"symbol":"CFG","id":89},
        {"symbol":"CHD","id":90},
        {"symbol":"CHRW","id":91},
        {"symbol":"CHTR","id":92},
        {"symbol":"CI","id":93},
        {"symbol":"CINF","id":94},
        {"symbol":"CL","id":95},
        {"symbol":"CLX","id":96},
        {"symbol":"CMA","id":97},
        {"symbol":"CMCSA","id":98},
        {"symbol":"CME","id":99},
        {"symbol":"CMG","id":100},
        {"symbol":"CMI","id":101},
        {"symbol":"CMS","id":102},
        {"symbol":"CNC","id":103},
        {"symbol":"CNP","id":104},
        {"symbol":"COF","id":105},
        {"symbol":"COO","id":106},
        {"symbol":"COP","id":107},
        {"symbol":"COR","id":108},
        {"symbol":"COST","id":109},
        {"symbol":"CPAY","id":110},
        {"symbol":"CPB","id":111},
        {"symbol":"CPRT","id":112},
        {"symbol":"CPT","id":113},
        {"symbol":"CRL","id":114},
        {"symbol":"CRM","id":115},
        {"symbol":"CSCO","id":116},
        {"symbol":"CSGP","id":117},
        {"symbol":"CSX","id":118},
        {"symbol":"CTAS","id":119},
        {"symbol":"CTLT","id":120},
        {"symbol":"CTRA","id":121},
        {"symbol":"CTSH","id":122},
        {"symbol":"CTVA","id":123},
        {"symbol":"CVS","id":124},
        {"symbol":"CVX","id":125},
        {"symbol":"CZR","id":126},
        {"symbol":"D","id":127},
        {"symbol":"DAL","id":128},
        {"symbol":"DAY","id":129},
        {"symbol":"DD","id":130},
        {"symbol":"DE","id":131},
        {"symbol":"DECK","id":132},
        {"symbol":"DFS","id":133},
        {"symbol":"DG","id":134},
        {"symbol":"DGX","id":135},
        {"symbol":"DHI","id":136},
        {"symbol":"DHR","id":137},
        {"symbol":"DIS","id":138},
        {"symbol":"DLR","id":139},
        {"symbol":"DLTR","id":140},
        {"symbol":"DOC","id":141},
        {"symbol":"DOV","id":142},
        {"symbol":"DOW","id":143},
        {"symbol":"DPZ","id":144},
        {"symbol":"DRI","id":145},
        {"symbol":"DTE","id":146},
        {"symbol":"DUK","id":147},
        {"symbol":"DVA","id":148},
        {"symbol":"DVN","id":149},
        {"symbol":"DXCM","id":150},
        {"symbol":"EA","id":151},
        {"symbol":"EBAY","id":152},
        {"symbol":"ECL","id":153},
        {"symbol":"ED","id":154},
        {"symbol":"EFX","id":155},
        {"symbol":"EG","id":156},
        {"symbol":"EIX","id":157},
        {"symbol":"EL","id":158},
        {"symbol":"ELV","id":159},
        {"symbol":"EMN","id":160},
        {"symbol":"EMR","id":161},
        {"symbol":"ENPH","id":162},
        {"symbol":"EOG","id":163},
        {"symbol":"EPAM","id":164},
        {"symbol":"EQIX","id":165},
        {"symbol":"EQR","id":166},
        {"symbol":"EQT","id":167},
        {"symbol":"ES","id":168},
        {"symbol":"ESS","id":169},
        {"symbol":"ETN","id":170},
        {"symbol":"ETR","id":171},
        {"symbol":"ETSY","id":172},
        {"symbol":"EVRG","id":173},
        {"symbol":"EW","id":174},
        {"symbol":"EXC","id":175},
        {"symbol":"EXPD","id":176},
        {"symbol":"EXPE","id":177},
        {"symbol":"EXR","id":178},
        {"symbol":"F","id":179},
        {"symbol":"FANG","id":180},
        {"symbol":"FAST","id":181},
        {"symbol":"FCX","id":182},
        {"symbol":"FDS","id":183},
        {"symbol":"FDX","id":184},
        {"symbol":"FE","id":185},
        {"symbol":"FFIV","id":186},
        {"symbol":"FI","id":187},
        {"symbol":"FICO","id":188},
        {"symbol":"FIS","id":189},
        {"symbol":"FITB","id":190},
        {"symbol":"FMC","id":191},
        {"symbol":"FOX","id":192},
        {"symbol":"FOXA","id":193},
        {"symbol":"FRT","id":194},
        {"symbol":"FSLR","id":195},
        {"symbol":"FTNT","id":196},
        {"symbol":"FTV","id":197},
        {"symbol":"GD","id":198},
        {"symbol":"GE","id":199},
        {"symbol":"GEHC","id":200},
        {"symbol":"GEN","id":201},
        {"symbol":"GILD","id":202},
        {"symbol":"GIS","id":203},
        {"symbol":"GL","id":204},
        {"symbol":"GLW","id":205},
        {"symbol":"GM","id":206},
        {"symbol":"GNRC","id":207},
        {"symbol":"GOOG","id":208},
        {"symbol":"GOOGL","id":209},
        {"symbol":"GPC","id":210},
        {"symbol":"GPN","id":211},
        {"symbol":"GRMN","id":212},
        {"symbol":"GS","id":213},
        {"symbol":"GWW","id":214},
        {"symbol":"HAL","id":215},
        {"symbol":"HAS","id":216},
        {"symbol":"HBAN","id":217},
        {"symbol":"HCA","id":218},
        {"symbol":"HD","id":219},
        {"symbol":"HES","id":220},
        {"symbol":"HIG","id":221},
        {"symbol":"HII","id":222},
        {"symbol":"HLT","id":223},
        {"symbol":"HOLX","id":224},
        {"symbol":"HON","id":225},
        {"symbol":"HPE","id":226},
        {"symbol":"HPQ","id":227},
        {"symbol":"HRL","id":228},
        {"symbol":"HSIC","id":229},
        {"symbol":"HST","id":230},
        {"symbol":"HSY","id":231},
        {"symbol":"HUBB","id":232},
        {"symbol":"HUM","id":233},
        {"symbol":"HWM","id":234},
        {"symbol":"IBM","id":235},
        {"symbol":"ICE","id":236},
        {"symbol":"IDXX","id":237},
        {"symbol":"IEX","id":238},
        {"symbol":"IFF","id":239},
        {"symbol":"ILMN","id":240},
        {"symbol":"INCY","id":241},
        {"symbol":"INTC","id":242},
        {"symbol":"INTU","id":243},
        {"symbol":"INVH","id":244},
        {"symbol":"IP","id":245},
        {"symbol":"IPG","id":246},
        {"symbol":"IQV","id":247},
        {"symbol":"IR","id":248},
        {"symbol":"IRM","id":249},
        {"symbol":"ISRG","id":250},
        {"symbol":"IT","id":251},
        {"symbol":"ITW","id":252},
        {"symbol":"IVZ","id":253},
        {"symbol":"J","id":254},
        {"symbol":"JBHT","id":255},
        {"symbol":"JBL","id":256},
        {"symbol":"JCI","id":257},
        {"symbol":"JKHY","id":258},
        {"symbol":"JNJ","id":259},
        {"symbol":"JNPR","id":260},
        {"symbol":"JPM","id":261},
        {"symbol":"K","id":262},
        {"symbol":"KDP","id":263},
        {"symbol":"KEY","id":264},
        {"symbol":"KEYS","id":265},
        {"symbol":"KHC","id":266},
        {"symbol":"KIM","id":267},
        {"symbol":"KLAC","id":268},
        {"symbol":"KMB","id":269},
        {"symbol":"KMI","id":270},
        {"symbol":"KMX","id":271},
        {"symbol":"KO","id":272},
        {"symbol":"KR","id":273},
        {"symbol":"L","id":274},
        {"symbol":"LDOS","id":275},
        {"symbol":"LEN","id":276},
        {"symbol":"LH","id":277},
        {"symbol":"LHX","id":278},
        {"symbol":"LIN","id":279},
        {"symbol":"LKQ","id":280},
        {"symbol":"LLY","id":281},
        {"symbol":"LMT","id":282},
        {"symbol":"LNT","id":283},
        {"symbol":"LOW","id":284},
        {"symbol":"LRCX","id":285},
        {"symbol":"LULU","id":286},
        {"symbol":"LUV","id":287},
        {"symbol":"LVS","id":288},
        {"symbol":"LW","id":289},
        {"symbol":"LYB","id":290},
        {"symbol":"LYV","id":291},
        {"symbol":"MA","id":292},
        {"symbol":"MAA","id":293},
        {"symbol":"MAR","id":294},
        {"symbol":"MAS","id":295},
        {"symbol":"MCD","id":296},
        {"symbol":"MCHP","id":297},
        {"symbol":"MCK","id":298},
        {"symbol":"MCO","id":299},
        {"symbol":"MDLZ","id":300},
        {"symbol":"MDT","id":301},
        {"symbol":"MET","id":302},
        {"symbol":"META","id":303},
        {"symbol":"MGM","id":304},
        {"symbol":"MHK","id":305},
        {"symbol":"MKC","id":306},
        {"symbol":"MKTX","id":307},
        {"symbol":"MLM","id":308},
        {"symbol":"MMC","id":309},
        {"symbol":"MMM","id":310},
        {"symbol":"MNST","id":311},
        {"symbol":"MO","id":312},
        {"symbol":"MOH","id":313},
        {"symbol":"MOS","id":314},
        {"symbol":"MPC","id":315},
        {"symbol":"MPWR","id":316},
        {"symbol":"MRK","id":317},
        {"symbol":"MRNA","id":318},
        {"symbol":"MRO","id":319},
        {"symbol":"MS","id":320},
        {"symbol":"MSCI","id":321},
        {"symbol":"MSFT","id":322},
        {"symbol":"MSI","id":323},
        {"symbol":"MTB","id":324},
        {"symbol":"MTCH","id":325},
        {"symbol":"MTD","id":326},
        {"symbol":"MU","id":327},
        {"symbol":"NCLH","id":328},
        {"symbol":"NDAQ","id":329},
        {"symbol":"NDSN","id":330},
        {"symbol":"NEE","id":331},
        {"symbol":"NEM","id":332},
        {"symbol":"NFLX","id":333},
        {"symbol":"NI","id":334},
        {"symbol":"NKE","id":335},
        {"symbol":"NOC","id":336},
        {"symbol":"NOW","id":337},
        {"symbol":"NRG","id":338},
        {"symbol":"NSC","id":339},
        {"symbol":"NTAP","id":340},
        {"symbol":"NTRS","id":341},
        {"symbol":"NUE","id":342},
        {"symbol":"NVDA","id":343},
        {"symbol":"NVR","id":344},
        {"symbol":"NWS","id":345},
        {"symbol":"NWSA","id":346},
        {"symbol":"NXPI","id":347},
        {"symbol":"O","id":348},
        {"symbol":"ODFL","id":349},
        {"symbol":"OKE","id":350},
        {"symbol":"OMC","id":351},
        {"symbol":"ON","id":352},
        {"symbol":"ORCL","id":353},
        {"symbol":"ORLY","id":354},
        {"symbol":"OTIS","id":355},
        {"symbol":"OXY","id":356},
        {"symbol":"PANW","id":357},
        {"symbol":"PARA","id":358},
        {"symbol":"PAYC","id":359},
        {"symbol":"PAYX","id":360},
        {"symbol":"PCAR","id":361},
        {"symbol":"PCG","id":362},
        {"symbol":"PEG","id":363},
        {"symbol":"PEP","id":364},
        {"symbol":"PFE","id":365},
        {"symbol":"PFG","id":366},
        {"symbol":"PG","id":367},
        {"symbol":"PGR","id":368},
        {"symbol":"PH","id":369},
        {"symbol":"PHM","id":370},
        {"symbol":"PKG","id":371},
        {"symbol":"PLD","id":372},
        {"symbol":"PM","id":373},
        {"symbol":"PNC","id":374},
        {"symbol":"PNR","id":375},
        {"symbol":"PNW","id":376},
        {"symbol":"PODD","id":377},
        {"symbol":"POOL","id":378},
        {"symbol":"PPG","id":379},
        {"symbol":"PPL","id":380},
        {"symbol":"PRU","id":381},
        {"symbol":"PSA","id":382},
        {"symbol":"PSX","id":383},
        {"symbol":"PTC","id":384},
        {"symbol":"PWR","id":385},
        {"symbol":"PXD","id":386},
        {"symbol":"PYPL","id":387},
        {"symbol":"QCOM","id":388},
        {"symbol":"QRVO","id":389},
        {"symbol":"RCL","id":390},
        {"symbol":"REG","id":391},
        {"symbol":"REGN","id":392},
        {"symbol":"RF","id":393},
        {"symbol":"RHI","id":394},
        {"symbol":"RJF","id":395},
        {"symbol":"RL","id":396},
        {"symbol":"RMD","id":397},
        {"symbol":"ROK","id":398},
        {"symbol":"ROL","id":399},
        {"symbol":"ROP","id":400},
        {"symbol":"ROST","id":401},
        {"symbol":"RSG","id":402},
        {"symbol":"RTX","id":403},
        {"symbol":"RVTY","id":404},
        {"symbol":"SBAC","id":405},
        {"symbol":"SBUX","id":406},
        {"symbol":"SCHW","id":407},
        {"symbol":"SHW","id":408},
        {"symbol":"SJM","id":409},
        {"symbol":"SLB","id":410},
        {"symbol":"SMCI","id":411},
        {"symbol":"SNA","id":412},
        {"symbol":"SNPS","id":413},
        {"symbol":"SO","id":414},
        {"symbol":"SPG","id":415},
        {"symbol":"SPGI","id":416},
        {"symbol":"SRE","id":417},
        {"symbol":"STE","id":418},
        {"symbol":"STLD","id":419},
        {"symbol":"STT","id":420},
        {"symbol":"STX","id":421},
        {"symbol":"STZ","id":422},
        {"symbol":"SWK","id":423},
        {"symbol":"SWKS","id":424},
        {"symbol":"SYF","id":425},
        {"symbol":"SYK","id":426},
        {"symbol":"SYY","id":427},
        {"symbol":"T","id":428},
        {"symbol":"TAP","id":429},
        {"symbol":"TDG","id":430},
        {"symbol":"TDY","id":431},
        {"symbol":"TECH","id":432},
        {"symbol":"TEL","id":433},
        {"symbol":"TER","id":434},
        {"symbol":"TFC","id":435},
        {"symbol":"TFX","id":436},
        {"symbol":"TGT","id":437},
        {"symbol":"TJX","id":438},
        {"symbol":"TMO","id":439},
        {"symbol":"TMUS","id":440},
        {"symbol":"TPR","id":441},
        {"symbol":"TRGP","id":442},
        {"symbol":"TRMB","id":443},
        {"symbol":"TROW","id":444},
        {"symbol":"TRV","id":445},
        {"symbol":"TSCO","id":446},
        {"symbol":"TSLA","id":447},
        {"symbol":"TSN","id":448},
        {"symbol":"TT","id":449},
        {"symbol":"TTWO","id":450},
        {"symbol":"TXN","id":451},
        {"symbol":"TXT","id":452},
        {"symbol":"TYL","id":453},
        {"symbol":"UAL","id":454},
        {"symbol":"UBER","id":455},
        {"symbol":"UDR","id":456},
        {"symbol":"UHS","id":457},
        {"symbol":"ULTA","id":458},
        {"symbol":"UNH","id":459},
        {"symbol":"UNP","id":460},
        {"symbol":"UPS","id":461},
        {"symbol":"URI","id":462},
        {"symbol":"USB","id":463},
        {"symbol":"V","id":464},
        {"symbol":"VICI","id":465},
        {"symbol":"VLO","id":466},
        {"symbol":"VMC","id":467},
        {"symbol":"VRSK","id":468},
        {"symbol":"VRSN","id":469},
        {"symbol":"VRTX","id":470},
        {"symbol":"VTR","id":471},
        {"symbol":"VTRS","id":472},
        {"symbol":"VZ","id":473},
        {"symbol":"WAB","id":474},
        {"symbol":"WAT","id":475},
        {"symbol":"WBA","id":476},
        {"symbol":"WBD","id":477},
        {"symbol":"WDC","id":478},
        {"symbol":"WEC","id":479},
        {"symbol":"WELL","id":480},
        {"symbol":"WFC","id":481},
        {"symbol":"WM","id":482},
        {"symbol":"WMB","id":483},
        {"symbol":"WMT","id":484},
        {"symbol":"WRB","id":485},
        {"symbol":"WRK","id":486},
        {"symbol":"WST","id":487},
        {"symbol":"WTW","id":488},
        {"symbol":"WY","id":489},
        {"symbol":"WYNN","id":490},
        {"symbol":"XEL","id":491},
        {"symbol":"XLB","id":492},
        {"symbol":"XLC","id":493},
        {"symbol":"XLE","id":494},
        {"symbol":"XLF","id":495},
        {"symbol":"XLI","id":496},
        {"symbol":"XLK","id":497},
        {"symbol":"XLP","id":498},
        {"symbol":"XLRE","id":499},
        {"symbol":"XLU","id":500},
        {"symbol":"XLV","id":501},
        {"symbol":"XLY","id":502},
        {"symbol":"XOM","id":503},
        {"symbol":"XYL","id":504},
        {"symbol":"YUM","id":505},
        {"symbol":"ZBH","id":506},
        {"symbol":"ZBRA","id":507},
        {"symbol":"ZTS","id":508},
        {"symbol":"KVUE","id":509},
        {"symbol":"VLTO","id":510},
        {"symbol":"GEV","id":511},
        {"symbol":"SOLV","id":512},
        {"symbol":"SPY","id":513}]

    # Pull last week of price data
    end_date = datetime.date.today()
    start_date = end_date - datetime.timedelta(days=7)
    
    symbol_list = [entry["symbol"] for entry in input_symbol]
    data = yf.download(symbol_list, start=start_date, end=end_date)
    print("Done downloading data.")

    # Unnest data
    data_unstack = data.stack(level=1)
    data_unstack.reset_index(inplace=True)
    data_unstack.rename(columns={
        "Date": "close_date",
        "Ticker": "symbol",
        "Adj Close": "adj_close",
        "Close": "close",
        "High": "high",
        "Low": "low",
        "Open": "open",
        "Volume": "volume"
    }, inplace=True)

    # Map to foreign symbol_id
    df_bridge_symbol_id = pd.DataFrame(input_symbol)
    df_charts_table = pd.merge(data_unstack, df_bridge_symbol_id, on="symbol", how="left")
    df_charts_table.rename(columns={"id": "symbol_id"}, inplace=True)
    df_charts_table.drop(columns=["symbol"], inplace=True)
    df_charts_table = df_charts_table[["symbol_id", "close_date", "open", "high", "low", "close", "adj_close"]]

    # Prep data for ready to insert
    df_charts_table["close_date"] = df_charts_table["close_date"].astype(str)
    new_records = df_charts_table.to_dict(orient="records")

    # Connect and write to supabase
    if len(df_charts_table) == 0:
        print("No data to insert. Returning...")
        
    supabase_client = create_client(os.environ.get("SUPABASE_API_URL"), os.environ.get("SUPABASE_API_KEY"))
    rows_uploaded = supabase_client.table("charts").insert(new_records).execute()

    if rows_uploaded.count == len(df_charts_table):
        print(f"Successfully inserted {rows_uploaded} records.")
    else:
        print(f"Failed to upload, inserted {rows_uploaded.count} out of {len(df_charts_table)} records.")
